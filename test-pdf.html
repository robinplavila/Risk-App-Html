<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Generation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <h1>Test PDF Generation</h1>
    
    <!-- Simulate form sections -->
    <div class="form-section" data-section="1">
        <input type="checkbox" name="sectors[]" value="ai" checked> AI
        <input type="checkbox" name="sectors[]" value="defi"> DeFi
        <input type="checkbox" name="sectors[]" value="robotics" checked> Robotics
    </div>
    
    <div class="form-section" data-section="2">
        <input type="text" name="legal_name" value="Test Company Inc.">
        <input type="text" name="incorporation_location" value="Ontario, Canada">
        <input type="radio" name="employees_outside_canada" value="yes" checked>
        <input type="text" name="employees_outside_list" value="USA: 5, UK: 2">
        <input type="text" name="breach_contact_name" value="John Doe">
        <input type="text" name="breach_contact_email" value="john@test.com">
    </div>
    
    <button onclick="testGeneratePDF()">Test Generate PDF</button>
    
    <script>
        // Test version of the functions
        function collectFormData() {
            const formData = {
                submissionDate: new Date().toLocaleDateString(),
                submissionTime: new Date().toLocaleTimeString(),
                sectors: [],
                generalInfo: {}
            };

            // Collect sectors
            $('input[name="sectors[]"]:checked').each(function() {
                formData.sectors.push($(this).val());
            });

            // Collect section 2 data
            $('.form-section[data-section="2"] input').each(function() {
                const $input = $(this);
                const name = $input.attr('name');
                const type = $input.attr('type');
                
                if (name) {
                    if (type === 'radio') {
                        if ($input.is(':checked')) {
                            formData.generalInfo[name] = $input.val();
                        }
                    } else {
                        const value = $input.val();
                        if (value && value.trim() !== '') {
                            formData.generalInfo[name] = value;
                        }
                    }
                }
            });

            console.log('Collected form data:', formData);
            return formData;
        }
        
        function testGeneratePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Collect all form data
                const formData = collectFormData();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const lineHeight = 6;
                
                // Helper function to add new page if needed
                function checkPageBreak(additionalHeight = 15) {
                    if (yPosition + additionalHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }
                
                // Helper function to add text with word wrapping
                function addWrappedText(text, x, fontSize = 10, maxWidth = 170) {
                    doc.setFontSize(fontSize);
                    const splitText = doc.splitTextToSize(text, maxWidth);
                    splitText.forEach(line => {
                        checkPageBreak();
                        doc.text(line, x, yPosition);
                        yPosition += lineHeight;
                    });
                }
                
                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Axis Technology Insurance Application', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Submitted: ${formData.submissionDate} at ${formData.submissionTime}`, margin, yPosition);
                yPosition += 15;
                
                // Section 1: Sectors - Enhanced with questions and options
                checkPageBreak(20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                addWrappedText('Section 1: Sectors', margin);
                yPosition += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                addWrappedText('Question: Does your business provide products or services within any of the following sectors?', margin + 10);
                yPosition += 3;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // Define all sector options
                const sectorOptions = [
                    { value: 'ai', label: '🤖 Artificial Intelligence' },
                    { value: 'defi', label: '💰 Decentralized Finance & Digital Assets' },
                    { value: 'robotics', label: '🦾 Autonomous Robotics' }
                ];
                
                sectorOptions.forEach(option => {
                    const isSelected = formData.sectors.includes(option.value);
                    const status = isSelected ? '☑️' : '☐';
                    addWrappedText(`${status} ${option.label}`, margin + 20);
                });
                
                yPosition += 10;
                
                // Enhanced function for Section 2 with questions and selected options
                function addSection2WithQuestions(sectionData) {
                    checkPageBreak(20);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    addWrappedText('Section 2: General Information', margin);
                    yPosition += 5;
                    
                    // Sample questions for testing
                    const section2Questions = [
                        {
                            question: '1. Legal Name of Organization',
                            field: 'legal_name',
                            type: 'text'
                        },
                        {
                            question: 'Location of Incorporation',
                            field: 'incorporation_location',
                            type: 'text'
                        },
                        {
                            question: '8. Are any Employees based outside of Canada?',
                            field: 'employees_outside_canada',
                            type: 'radio',
                            options: [
                                { value: 'yes', label: 'Yes' },
                                { value: 'no', label: 'No' }
                            ],
                            followUp: {
                                condition: 'yes',
                                question: 'If yes, list the country and the number of employees in each:',
                                field: 'employees_outside_list'
                            }
                        },
                        {
                            question: '9. Breach Response Contact',
                            fields: [
                                { field: 'breach_contact_name', label: 'Name' },
                                { field: 'breach_contact_email', label: 'Email' }
                            ],
                            type: 'composite'
                        }
                    ];
                    
                    section2Questions.forEach(q => {
                        checkPageBreak(15);
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        addWrappedText(q.question, margin + 10);
                        yPosition += 2;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        
                        if (q.type === 'text' || q.type === 'textarea' || q.type === 'number') {
                            const value = sectionData[q.field];
                            if (value) {
                                addWrappedText(`Answer: ${value}`, margin + 20);
                            } else {
                                addWrappedText('Answer: Not provided', margin + 20);
                            }
                        } else if (q.type === 'radio') {
                            const selectedValue = sectionData[q.field];
                            q.options.forEach(option => {
                                const isSelected = selectedValue === option.value;
                                const status = isSelected ? '◉' : '◯';
                                addWrappedText(`${status} ${option.label}`, margin + 20);
                            });
                            
                            // Handle follow-up questions
                            if (q.followUp && selectedValue === q.followUp.condition) {
                                yPosition += 2;
                                doc.setFont(undefined, 'italic');
                                addWrappedText(q.followUp.question, margin + 25);
                                doc.setFont(undefined, 'normal');
                                const followUpValue = sectionData[q.followUp.field];
                                if (followUpValue) {
                                    addWrappedText(`Answer: ${followUpValue}`, margin + 30);
                                } else {
                                    addWrappedText('Answer: Not provided', margin + 30);
                                }
                            }
                        } else if (q.type === 'composite') {
                            q.fields.forEach(field => {
                                const value = sectionData[field.field];
                                addWrappedText(`${field.label}: ${value || 'Not provided'}`, margin + 20);
                            });
                        }
                        
                        yPosition += 8;
                    });
                    
                    yPosition += 5;
                }
                
                // Section 2: General Information - Enhanced with questions and options
                addSection2WithQuestions(formData.generalInfo);
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
                const filename = `Test-PDF-${timestamp}.pdf`;
                
                // Save the PDF
                doc.save(filename);
                
                console.log('PDF generated successfully!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        }
    </script>
</body>
</html>